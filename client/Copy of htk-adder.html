<!-- 
 date: 04/01/2018
 author: Andre' Neto
 
 copyright: Copyright 2017 F4E | European Joint Undertaking for ITER and
 the Development of Fusion Energy ('Fusion for Energy').
 Licensed under the EUPL, Version 1.1 or - as soon they will be approved
 by the European Commission - subsequent versions of the EUPL (the "Licence")
 You may not use this work except in compliance with the Licence.
 You may obtain a copy of the Licence at: http://ec.europa.eu/idabc/eupl
 
 warning: Unless required by applicable law or agreed to in writing, 
 software distributed under the Licence is distributed on an "AS IS"
 basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 or implied. See the Licence permissions and limitations under the Licence.
--> 

<html>
    <head>
        <!-- Standard imports -->

        <!-- Project imports -->
        <link rel="import" href="/htk-helper.html">
    </head>
    </body>
        <!-- HTML5 component template-->
        <template id="tcomponentsinclusion">
                <div id="dcomponentsinclusion">
                    <table border="0" id="mainTable">
                        <tr>
							<td>
								<button type="button" id="addComponentButton" style="height:29px;width=150px">Add Component</button>
							</td>				
							<td>
								<button type="button" id="remComponentButton" style="height:29px;width=150px">Remove Component</button>
							</td>				

                        </tr>
                    </table>
            	</div>
        </template>

        <script>
            //This is enclosure is required to protect the importDoc
            (function () {
                var importDoc = document.currentScript.ownerDocument; // importee

                /**
                 * @brief A dialog which allows to select a new Hieratika page to be displayed (amonsgst all the Hieratika pages returned by the server.
                 */
                class HtkComponentInclusion extends HtkComponent {

                    /**
                     * @brief Constructor. NOOP.
                     */
                    constructor() {
                        super();
                    }


                    domLoaded(){
						var gammatrixId=this.getAttribute("data-gammatrixId");
						var dsmatrixId=this.getAttribute("data-dsmatrixId");
						
						var ifmatrixId=this.getAttribute("data-ifmatrixId");
						var objmatrixId=this.getAttribute("data-objmatrixId");
						var compmatrixId=this.getAttribute("data-compmatrixId");
						
						var htkCompArray = document._frameComponents[gammatrixId];
					    this.gammatrix=htkCompArray[0];
						var htkCompArray = document._frameComponents[dsmatrixId];
					    this.dsmatrix=htkCompArray[0];

						var htkCompArray = document._frameComponents[ifmatrixId];
					    this.ifmatrix=htkCompArray[0];

						var htkCompArray = document._frameComponents[objmatrixId];
					    this.objmatrix=htkCompArray[0];

					    var htkCompArray = document._frameComponents[compmatrixId];
					    this.compmatrix=htkCompArray[0];
					    
						this.ifmatrix.showHideButtons(false);
						this.gammatrix.showHideButtons(false);
						this.dsmatrix.showHideButtons(false);
						this.objmatrix.showHideButtons(false);
						this.compmatrix.showHideButtons(false);
						
						this.ifmatrix.addUpdateValueCallback(this);
					    this.gammatrix.addUpdateValueCallback(this);
					    this.dsmatrix.addUpdateValueCallback(this);	
						this.objmatrix.addUpdateValueCallback(this);
					    					    			
                        this.addComponentButton = this.shadowRoot.querySelector("#addComponentButton");
                        this.addComponentButton.style.width = "170px";
    					this.addComponentButton.style.height = "29px";
                        this.addComponentButton.onclick = function() {
                        	this.value.push(this.nextValue);
                            var choices =copy(this.value);
                            choices.unshift("");                        	
                        	this.compmatrix.refreshFromEnum(choices);	
                            this.fireValueChanged("value");
                            this.updateRemote(this.value);
                		    for(var i=0; i<this.addUpdateValueListeners.length; i++){
        		               	this.addUpdateValueListeners[i].updateValue(this);
		                    }                                
                        }.bind(this);

                        this.remComponentButton = this.shadowRoot.querySelector("#remComponentButton");
                        this.remComponentButton.style.width = "170px";
    					this.remComponentButton.style.height = "29px";
                        this.remComponentButton.onclick = function() {
                            var temp = copy(this.value);
                            this.value=[];
                            for(var i=0; i<temp.length; i++){
                                if(temp[i] != this.compmatrix.value[0][0]){
                                    this.value.push(temp[i]);
                                }
                            }
                            var choices =copy(this.value);
                            choices.unshift("");
                        	this.compmatrix.refreshFromEnum(choices);	
                            this.fireValueChanged("value");
                            this.updateRemote(this.value);
                		    for(var i=0; i<this.addUpdateValueListeners.length; i++){
        		               	this.addUpdateValueListeners[i].updateValue(this);
		                    }                                
                        }.bind(this);

                    
                    	this.objects=[];
                    	this.gamObjects=[];
                    	this.dsObjects=[];
                    	this.ifObjects=[];
                    	
						parent.htkHelper.getGams(
                           	function (componentsJson) {
                           		var gams = [];
                               	for (var p in componentsJson) {
                                   	var componentName = componentsJson[p].name;
                                   	gams.push(componentName);
	                            }
	                            this.initGamMatrix(gams);
            	            }.bind(this),
	                        function () {
            	            }
                        );                    
                
                    }

					initialized(){
					    this.prevGam=this.gamObjects[0];
                        this.prevDs=this.dsObjects[0];                        
                        this.prevIf=this.ifObjects[0];                        
                        this.prevObj=this.objects[0];      
                        this.nextValue=this.prevGam;    
					}

					initGamMatrix(gams){
	                      for (var i=0; i<gams.length; i++){
                            	parent.htkHelper.getGamObjects(
                                	gams[i],
                                	function (componentsJson) {

                               	     for (var p in componentsJson) {
                               	         var componentName = componentsJson[p].name;
										 var index=componentName.search("_GAM");
                              	         if(index!=-1){
                                    		 componentName=componentName.substr(0,index);
                                    		 this.gamObjects.push(componentName);
                                    	 }                                      
                                  		 index=componentName.search("_Object");
                                    	 if(index!=-1){
                                    		 componentName=componentName.substr(0,index);
                                    		 this.objects.push(componentName);
                                    	 }                                  	         
                               	     }
                               	     this.initialized();
                               	     var choices = copy(this.objects);
                               	     choices.unshift("");
                               	     this.objmatrix.refreshFromEnum(choices);
                               	     choices = copy(this.gamObjects);
                               	     choices.unshift("");
                               	     this.gammatrix.refreshFromEnum(choices);
                               	     this.gammatrix.setValue([[this.gamObjects[0]]]);
									parent.htkHelper.getDatasources(
                           				function (componentsJson) {
										var dss = [];
                               			for (var p in componentsJson) {
                                   		var componentName = componentsJson[p].name;
                                   		dss.push(componentName);
	                            	}
	                            	this.initDsMatrix(dss);
            	            		}.bind(this),
	                        		function () {
            	              		}
	                                );  
                               	 }.bind(this),
                               	 function () {
                           	     }
                        	    );	                            
                          }
                    }
                    
                    
					initDsMatrix(dss){
	                      for (var i=0; i<dss.length; i++){
                            	parent.htkHelper.getDatasourceObjects(
                                	dss[i],
                                	function (componentsJson) {

                               	     for (var p in componentsJson) {
                               	         var componentName = componentsJson[p].name;
										 var index=componentName.search("_DataSource");
                              	         if(index!=-1){
                                    		 componentName=componentName.substr(0,index);
                                    		 this.dsObjects.push(componentName);
                                    	 }                                      
                                  		 index=componentName.search("_Object");
                                    	 if(index!=-1){
                                    		 componentName=componentName.substr(0,index);
                                    		 this.objects.push(componentName);
                                    	 }                                  	         
                               	     }
                               	     this.initialized();
                               	     var choices = copy(this.objects);
                               	     choices.unshift("");                               	     
                               	     this.objmatrix.refreshFromEnum(choices);
                               	     choices = copy(this.dsObjects);
                               	     choices.unshift("");
                               	     this.dsmatrix.refreshFromEnum(choices);
                               	     this.dsmatrix.setValue([[this.dsObjects[0]]]);
									parent.htkHelper.getInterfaces(
                           			function (componentsJson) {
										var ifs = [];
                        		       	for (var p in componentsJson) {
                		                   	var componentName = componentsJson[p].name;
        		                           	ifs.push(componentName);
			                            }
	                            		this.initIfMatrix(ifs);
            	        		    }.bind(this),
	            		            function () {
    	    	    	            }
	    	                    	);    
                               	 }.bind(this),
                               	 function () {
                           	     }
                        	    );	                            
                          }
                    }                    

					initIfMatrix(ifs){
	                      for (var i=0; i<ifs.length; i++){
                            	parent.htkHelper.getInterfaceObjects(
                                	ifs[i],
                                	function (componentsJson) {

                               	     for (var p in componentsJson) {
                               	         var componentName = componentsJson[p].name;
										 var index=componentName.search("_Interface");
                              	         if(index!=-1){
                                    		 componentName=componentName.substr(0,index);
                                    		 this.ifObjects.push(componentName);
                                    	 }                                      
                                  		 index=componentName.search("_Object");
                                    	 if(index!=-1){
                                    		 componentName=componentName.substr(0,index);
                                    		 this.objects.push(componentName);
                                    	 }                                  	         
                               	     }
                               	     this.initialized();
                               	     var choices = copy(this.objects);
                               	     choices.unshift("");                                  	     
                               	     this.objmatrix.refreshFromEnum(choices);
                               	     choices = copy(this.ifObjects);
                               	     choices.unshift("");             
                               	     this.ifmatrix.refreshFromEnum(choices);
                               	     this.ifmatrix.setValue([[this.ifObjects[0]]]);
                               	     this.objmatrix.setValue([[this.objects[0]]]);
                               	     parent.htkDialogs.closeWaitDialog();
                               	     this.ok = true;
                               	 }.bind(this),
                               	 function () {
                           	     }
                        	    );	                            
                          }
                    }  

                updateValue(userChanged){
                	if(this.objmatrix.value[0][0] != this.prevObj){
                		this.nextValue=this.objmatrix.value[0][0];
                		this.prevObj=this.nextValue;
                	}
                	if(this.gammatrix.value[0][0] != this.prevGam){
                		this.nextValue=this.gammatrix.value[0][0];
                		this.prevGam=this.nextValue;
                	}                	
                	if(this.dsmatrix.value[0][0] != this.prevDs){
                		this.nextValue=this.dsmatrix.value[0][0];
                		this.prevDs=this.nextValue;
                	}                	
                	if(this.ifmatrix.value[0][0] != this.prevIf){
                		this.nextValue=this.ifmatrix.value[0][0];
                		this.prevIf=this.nextValue;
                	}         
                       	       	
                }
                
					
					scheduleChanged(x){
					}


					variablesInfoLoaded(){
					}


                    /**
                     * @brief See HtkComponent.refresh
                     */
                    refresh() {
                    }
                  
                    /** 
                     * @brief See HtkComponent.setValue
                     */
                    setValue (elementsToSet, updateRemote=true) {
                        if (elementsToSet.length > 0) {
    						super.setValue(elementsToSet.slice(0), updateRemote);
    						this.initialised=true;
    					}
                    }

                    /** 
                     * @brief See HtkComponent.setInitialValue
                     */
                    setInitialValue (initialValueToSet) {
                        if (initialValueToSet.length > 0) {
                            super.setInitialValue(initialValueToSet.slice(0));
                        }
                    }

                    /** 
                     * @brief See HtkComponent.setPlantValue
                     */
                    setPlantValue (plantValueToSet) {
                        if (plantValueToSet.length > 0) {
                            super.setPlantValue(plantValueToSet.slice(0));
                        }
                    }
 
                    /** 
                     * @brief See HtkComponent.setReferenceValue
                     */
                    setReferenceValue (referenceValueToSet) {
                        if (referenceValueToSet.length > 0) {
                            super.setReferenceValue(referenceValueToSet.slice(0));
                        }
                    }
 
                    /** 
                     * @brief See HtkComponent.setReadOnly
                     */
                    setReadOnly (isReadOnly) {
                        super.setReadOnly(isReadOnly);
                    }

                    /** 
                     * @brief See HtkComponent.getTemplate
                     */
                    getTemplate() {
                        var template = importDoc.querySelector("#tcomponentsinclusion");
                        return template;
                    }
                    
					addUpdateValueCallback(comp){
		            	this.addUpdateValueListeners.push(comp);
					}                    
                    
                    /**
                     * @brief Registers the dialog.
                     */
                    createdCallback () {
                    	super.createdCallback();
						parent.htkHelper.addVariablesInfoLoadedListener(this);
						parent.htkHelper.addScheduleChangedListener(this);    
						this.value=[];
						this.addUpdateValueListeners=[];
                    }
                

				}
                /**
                 * @brief Registers the element.
                 */ 
                document.registerElement("htk-component-inclusion", {
                    prototype: HtkComponentInclusion.prototype,
                });                 

            }());
        </script>

    </body>
</html>
