<!-- 
 date: 04/01/2018
 author: Andre' Neto
 
 copyright: Copyright 2017 F4E | European Joint Undertaking for ITER and
 the Development of Fusion Energy ('Fusion for Energy').
 Licensed under the EUPL, Version 1.1 or - as soon they will be approved
 by the European Commission - subsequent versions of the EUPL (the "Licence")
 You may not use this work except in compliance with the Licence.
 You may obtain a copy of the Licence at: http://ec.europa.eu/idabc/eupl
 
 warning: Unless required by applicable law or agreed to in writing, 
 software distributed under the Licence is distributed on an "AS IS"
 basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 or implied. See the Licence permissions and limitations under the Licence.
--> 

<html>
    <head>
        <!-- Standard imports -->

        <!-- Project imports -->
        <link rel="import" href="/libraries.html">
        <link rel="import" href="/htk-helper.html">
        <link rel="import" href="/htk-login.html">
        <link rel="import" href="/htk-main-editor.html">
        <link rel="import" href="/htk-page-selector.html">
        <link rel="import" href="/htk-project-saver.html">
        <link rel="import" href="/htk-component-selector.html">
        <link rel="import" href="/htk-switch-selector.html">
        <link rel="import" href="/htk-schedule-selector.html">
        <link rel="import" href="/htk-stream.html">
        <link rel="import" href="/htk-transformations.html">
    </head>
    <body>
        <!-- HTML5 component template-->
        <template id="ttopnav">
            <style>
                @import url("/css/w3.css");
                @import url("/css/font-awesome-4.7.0/css/font-awesome.min.css");
            </style>
            <div class="w3-sidebar w3-bar-block w3-dark-grey w3-animate-left w3-large" style="display:none" id="tsidebar">
                <button class="w3-bar-item w3-button w3-tiny w3-light-grey" id="tsidebarclose"><i class="fa fa-arrow-left"></i></button>
                <button class="w3-bar-item w3-button w3-border-bottom" id="loginbtn"><i class="fa fa-user-o"> Login</i></button>
                <button href="#" class="w3-bar-item w3-button w3-border-bottom" title="Set the current page" id="pageselectbtn"><i class="fa fa-external-link"> Open</i></button>
                <button class="w3-button w3-block w3-left-align" id="tviewaccbtn"><i class="fa fa-info"></i> View <i class="fa fa-caret-down"></i></button>
                <div id="tviewacc" class="w3-hide w3-green w3-card">
                    <button class="w3-bar-item w3-button w3-text-white" title="View the plant" id="viewplantbtn"><i class="fa fa-thermometer-full"></i> Plant</button>
                    <button class="w3-bar-item w3-button w3-text-white" title="Edit a schedule" id="viewschedulebtn"><i class="fa fa-code-fork"></i> Schedule</button>
                </div>
                <button class="w3-bar-item w3-button w3-border-bottom" title="Add a component" id="addcompbtn"><i class="fa fa-spinner"></i> Add</button>
                <button class="w3-bar-item w3-button w3-border-bottom" title="Switch to component" id="switchbtn"><i class="fa-refresh"></i> Switch</button>
                <button class="w3-bar-item w3-button w3-border-bottom" id="editschedulebtn"><i class="fa fa-code-fork"></i> Edit</button>
                <button class="w3-button w3-block w3-left-align" id="trefaccbtn"><i class="fa fa-ellipsis-v"></i> Compare <i class="fa fa-caret-down"></i></button>
                <div id="trefacc" class="w3-hide w3-green w3-card">
                    <button class="w3-bar-item w3-button w3-text-white" title="Remove the reference" id="refselectnonebtn"><i class="fa fa-times" style="color:#cc0000;"></i> Remove</button>
                    <button class="w3-bar-item w3-button w3-text-white" title="Set the plant as the reference" id="refselectplantbtn"><i class="fa fa-thermometer-full"></i> Plant</button>
                    <button class="w3-bar-item w3-button w3-text-white" title="Set another schedule as the reference" id="refselectschedulebtn"><i class="fa fa-code-fork"></i> Schedule</button>
                </div>
                <button class="w3-bar-item w3-button w3-border-bottom" title="Add a component" id="addcompbtn"><i class="fa fa-spinner"></i> Add</button>
                <button class="w3-bar-item w3-button w3-border-bottom" title="Copy the project" id="tcpyaccbtn"><i class="fa fa-files-o"></i> Copy </button>
                <div id="tcpyacc" class="w3-hide w3-green w3-card">
                    <button class="w3-bar-item w3-button w3-text-white" title="Copy from the plant" id="cpyreferenceplantbtn"><i class="fa fa-thermometer-full"></i> Plant</button>
                    <button class="w3-bar-item w3-button w3-text-white" title="Copy from a given schedule" id="cpyreferenceschedulebtn"><i class="fa fa-code-fork"></i> Schedule</button>
                </div>
                <button class="w3-bar-item w3-button w3-border-top" title="Commit all changes to current schedule" id="commitbtn"><i class="fa fa-floppy-o"></i> Commit</button>
                <button class="w3-bar-item w3-button" title="Undo all changes" id="undobtn"><i class="fa fa-undo"></i> Undo</button>
                <button class="w3-bar-item w3-button" title="Download the configuration" id="downloadbtn"><i class="fa fa-download"></i>Download</button>
                <button class="w3-bar-item w3-button w3-border-top" title="Manage transformations" id="transformationsbtn"><i class="fa fa-cogs"></i> f(x)</button>
                <button class="w3-bar-item w3-button w3-border-top" title="Load the current plant into the system" id="loadintoplantbtn"><i class="fa fa-upload"></i> Load</button>
                <button class="w3-bar-item w3-button w3-border-top" title="Show system statistics" id="showstatisticsbtn"><i class="fa fa-area-chart"></i> Statistics</button>
            </div>
            <div class="w3-bar w3-dark-grey w3-tiny">
                <button class="w3-button" id="tsidebaropen">&#9776;</button>
                <span class="w3-bar-item w3-right" id="currentdisplay">None</span>
                <span class="w3-bar-item w3-right w3-border-left">Displaying: </span>
                <span class="w3-bar-item w3-right" id="currentreference">None</span>
                <span class="w3-bar-item w3-right w3-border-left">Reference: </span>
                <span class="w3-bar-item w3-right" id="username">(login first)</span>
                <span class="w3-bar-item w3-right w3-border-left">Username: </span>
            </div>
            <htk-login id="htklogin"></htk-login>
            <htk-page-selector id="projectselector"></htk-page-selector>
            <htk-component-selector id="componentselector"></htk-component-selector>
            <htk-switch-selector id="switchselector"></htk-switch-selector>
            <htk-project-saver id="projectsaver"></htk-project-saver>
            <htk-schedule-selector id="scheduleselector"></htk-schedule-selector>
            <htk-transformations id="transformations"></htk-transformations>
        </template>

        <script>
            //This is enclosure is required to protect the importDoc
            (function () {
                var importDoc = document.currentScript.ownerDocument; // importee
        
                /**
                 * @brief Hieratika navigation pane.
                 */
                class HtkNav extends HTMLElement {
        
                    /**
                     * @brief Constructor. NOOP.
                     */
                    constructor() {
                        super();
                    }

                    /**
                     * @brief See HTMLElement.createdCallback.
                     */
                    createdCallback () {
                        var template = importDoc.querySelector("#ttopnav");
                        // import template into
                        var clone = document.importNode(template.content, true);
                        var root = this.createShadowRoot();
                        root.appendChild(clone);

                        this.sideBar = this.shadowRoot.querySelector("#tsidebar");
                        var sideBarOpen = this.shadowRoot.querySelector("#tsidebaropen");
                        var sideBarClose = this.shadowRoot.querySelector("#tsidebarclose");
                        sideBarOpen.onclick = function(evt) {
                            this.sideBar.style.display = "block";
                        }.bind(this); 

                        sideBarClose.onclick = function() {
                            this.hideSideBar();
                        }.bind(this); 

                        var viewAccordion = this.shadowRoot.querySelector("#tviewacc");
                        var viewAccordionButton = this.shadowRoot.querySelector("#tviewaccbtn");
                        viewAccordionButton.onclick = function() {
                            this.handleAccordionClick(viewAccordion);
                        }.bind(this);

                        var refAccordion = this.shadowRoot.querySelector("#trefacc");
                        var refAccordionButton = this.shadowRoot.querySelector("#trefaccbtn");
                        refAccordionButton.onclick = function() {
                            this.handleAccordionClick(refAccordion);
                        }.bind(this);

                        var copyAccordion = this.shadowRoot.querySelector("#tcpyacc");
                        this.copyAccordionButton = this.shadowRoot.querySelector("#tcpyaccbtn");
                        this.projectSaver = this.shadowRoot.querySelector("#projectsaver");
                        this.copyAccordionButton.onclick = function() {
                            this.hideSideBar();
                            parent.htkHelper.setCurrentScheduleUID(undefined);
                            this.projectSaver.show(this.saveProject.bind(this));
                        }.bind(this);

                        this.downloadButton = this.shadowRoot.querySelector("#downloadbtn");
                        this.downloadButton.onclick = function() {
                            this.hideSideBar();
                            parent.htkDialogs.showWaitDialog();
                            parent.htkHelper.downloadCfg(this.selectedproject);
                        }.bind(this);
            
                        this.loadIntoPlantButton = this.shadowRoot.querySelector("#loadintoplantbtn");
                        this.loadIntoPlantButton.onclick = function() {
                            this.hideSideBar();
                            parent.htkDialogs.showWaitDialog();
                            parent.htkHelper.loadIntoPlant(this.selectedproject, parent.htkHelper.getUser().username, this.loadIntoPlantCompleted, this.loadIntoPlantError);
                        }.bind(this);

                        this.showStatisticsButton = this.shadowRoot.querySelector("#showstatisticsbtn");
                        this.showStatisticsButton.onclick = function() {
                            this.hideSideBar();
                            parent.htkHelper.getHtkMainEditor().showStatistics();
                        }.bind(this);

                        this.projectSelectButton = this.shadowRoot.querySelector("#pageselectbtn");
                        this.switchSelectorButton = this.shadowRoot.querySelector("#switchbtn");
                        this.switchSelectorButton.disabled =true;

                        this.loginButton = this.shadowRoot.querySelector("#loginbtn");
                        this.loginDialog = this.shadowRoot.querySelector("#htklogin");
                        this.loginDialog.addLoginListener(this);
                        this.loginButton.onclick = function() {
                            this.hideSideBar();
                            var user = parent.htkHelper.getUser(); 
                            if (user === undefined) {
                                this.loginDialog.show();
                            }
                            else {
                                this.fireUserLogout();
                            }
                        }.bind(this);

                        this.standalone = this.getAttribute("data-standalone");
                        if (this.standalone !== undefined) {
                            this.standalone = (this.standalone.toLowerCase() === "true");
                        }
                        else {
                            this.standalone = false;
                        }
                        if (!this.standalone) {
                            this.streamer = new Stream();
                        }
                        this.loginButton.disabled = this.standalone;

                        this.projectSelector = this.shadowRoot.querySelector("#projectselector");
                        this.projectSelectButton.onclick = function() {
                            this.hideSideBar();
                            parent.htkHelper.setCurrentScheduleUID(undefined);
                            this.projectSelector.show(this.fireProjectChanged.bind(this));
                        }.bind(this);

                        this.switchSelector = this.shadowRoot.querySelector("#switchselector");
                        this.switchSelectorButton.onclick = function() {
                            this.hideSideBar();
                            parent.htkHelper.setCurrentScheduleUID(undefined);
                            this.switchSelector.show(this.firePageChanged.bind(this));
                        }.bind(this);
                       
                        this.componentSelectButton = this.shadowRoot.querySelector("#addcompbtn");
                        this.componentSelector = this.shadowRoot.querySelector("#componentselector");
                        this.componentSelectButton.onclick = function() {
                            this.hideSideBar();
                            parent.htkHelper.setCurrentScheduleUID(undefined);
                            this.componentSelector.show(this.fireComponentChanged.bind(this));
                        }.bind(this);

                        this.scheduleSelector = this.shadowRoot.querySelector("#scheduleselector");
                        this.editScheduleButton = this.shadowRoot.querySelector("#editschedulebtn");
                        this.editScheduleButton.onclick = function() {
                            this.hideSideBar();
                            this.scheduleSelector.show(this.editScheduleChanged.bind(this), true, true, true);
                        }.bind(this);

                        this.viewScheduleButton = this.shadowRoot.querySelector("#viewschedulebtn");
                        this.viewScheduleButton.onclick = function() {
                            this.hideSideBar();
                            this.handleAccordionClick(viewAccordion);
                            this.scheduleSelector.show(this.viewScheduleChanged.bind(this));
                        }.bind(this);

                        this.viewPlantButton = this.shadowRoot.querySelector("#viewplantbtn");
                        this.viewPlantButton.onclick = function() {
                            this.hideSideBar();
                            this.handleAccordionClick(viewAccordion);
                            parent.htkHelper.setCurrentScheduleUID(undefined);
                            this.currentDisplay.innerHTML = PLANT_NAME;
                            this.downloadButton.disabled = true;
                            this.copyFromReferenceScheduleButton.disabled = true;
                            this.copyFromReferencePlantButton.disabled = true;
                            this.commitButton.disabled = true;
                            this.copyAccordionButton.disabled = true;
                            this.undoButton.disabled = true;
                            parent.htkHelper.displayPlant();
                        }.bind(this);

                        this.usernameDisplay = this.shadowRoot.querySelector("#username");
                        this.currentDisplay = this.shadowRoot.querySelector("#currentdisplay");
                        this.currentReference = this.shadowRoot.querySelector("#currentreference");
                        
                        var user = parent.htkHelper.getUser();
                        if (user === undefined) {
                            this.loginButton.value = "<i class='fa fa-user-o'> Login</i>";
                        }
                        else {
                            parent.htkHelper.setToken(localStorage.currentToken);
                            this.loginSuccessful(user);
                        }
                        this.projectSelect = this.shadowRoot.querySelector("#projectselect");

                        this.referenceSelectNoneButton = this.shadowRoot.querySelector("#refselectnonebtn");
                        this.referenceSelectNoneButton.onclick = function () {
                            this.hideSideBar();
                            this.handleAccordionClick(refAccordion);
                            this.setReference(NONE_NAME);
                            this.currentReference.innerHTML = NONE_NAME; 
                            this.currentReference.style.color = NONE_COLOR;
                        }.bind(this);

                        this.referenceSelectPlantButton = this.shadowRoot.querySelector("#refselectplantbtn");
                        this.referenceSelectPlantButton.onclick = function () {
                            this.hideSideBar();
                            this.handleAccordionClick(refAccordion);
                            this.setReference(PLANT_NAME);
                            this.currentReference.innerHTML = PLANT_NAME; 
                        }.bind(this);

                        this.referenceSelectScheduleButton = this.shadowRoot.querySelector("#refselectschedulebtn");
                        this.referenceSelectScheduleButton.onclick = function () {
                            this.hideSideBar();
                            this.handleAccordionClick(refAccordion);
                            this.scheduleSelector.show(this.refererenceScheduleChanged.bind(this));
                        }.bind(this); 

                        this.copyFromReferenceScheduleButton = this.shadowRoot.querySelector("#cpyreferenceschedulebtn");
                        this.copyFromReferenceScheduleButton.onclick = function () {
                            this.hideSideBar();
                            this.handleAccordionClick(copyAccordion);
                            this.scheduleSelector.show(this.copyFromScheduleChanged.bind(this));
                        }.bind(this);

                        this.copyFromReferencePlantButton = this.shadowRoot.querySelector("#cpyreferenceplantbtn");
                        this.copyFromReferencePlantButton.onclick = function () {
                            this.hideSideBar();
                            this.handleAccordionClick(copyAccordion);
                            var mainFrameHtkComponents = parent.htkHelper.getAllMainFrameHtkComponents();
                            var keys = Object.keys(mainFrameHtkComponents);
                            for (var i=0; i<keys.length; i++) {
                                var htkCompArray = mainFrameHtkComponents[keys[i]];
                                for (var j=0; j<htkCompArray.length; j++) {
                                    var htkComp = htkCompArray[j];
                                    htkComp.setValue(htkComp.getPlantValue());
                                }
                            }
                        }.bind(this);


                        this.commitButton = this.shadowRoot.querySelector("#commitbtn");
                        this.commitButton.onclick = function () {
                            this.hideSideBar();
                            parent.htkDialogs.showWaitDialog();
                            var xmlFile=this.selectedPage+".xml";
                            parent.htkHelper.commitAllChangesToSchedule(parent.htkHelper.htkNav.selectedproject, parent.htkHelper.getUser().username, xmlFile, this.commitCompleted, this.commitError);
                        }.bind(this);

                        this.undoButton = this.shadowRoot.querySelector("#undobtn");
                        this.undoButton.onclick = function () {
                            this.hideSideBar();
                            this.undoAllChangesToSchedule();
                        }.bind(this);

                        this.transformationsViewer = this.shadowRoot.querySelector("#transformations");
                        this.transformationsButton = this.shadowRoot.querySelector("#transformationsbtn");
                        this.transformationsButton.onclick = function() {
                            this.transformationsViewer.show();
                        }.bind(this);


                        this.streamer.addTransformationListener(this.transformationsViewer);

                        setInterval(parent.htkHelper.setHtkNav(this), 2000);
                        
                        parent.htkHelper.addInvalidTokenListener(this);
                        this.pageListeners = [this];
                        this.projectListeners = [];
                        this.componentListeners = [this];
                        this.scheduleChangeListeners = [this];
                        this.userLogoutListeners = [this];
                        //this.addPageListener(this.scheduleSelector);
                        this.disableAllButPageSelect();
                        
                        this.gamList=[];
                        this.datasourceList=[];
                        this.interfaceList=[];
                    }
        

                    /**
                     * @brief See HTMLElement.attachedCallback.
                     */
                    attachedCallback() {
                        if (this.standalone) {
                            this.loginDialog.loginToServer("", "");
                        }
                    }

                    /**
                     * @brief Callback function that is called when the load of the variables into the plant has been (asynchronously) completed successfully.
                     */
                    loadIntoPlantCompleted() {
                        parent.htkDialogs.closeWaitDialog();
                        parent.htkDialogs.showInformationDialog("Plant loaded successfully");
                    }

                    /**
                     * @brief Callback function that is called when the load of the variables into the plant has been (asynchronously) completed with an error.
                     */
                    loadIntoPlantError() {
                        parent.htkDialogs.closeWaitDialog();
                        parent.htkDialogs.showErrorDialog("Failed to load the values into the plant. Unknown error, check the server logs.");
                    }

                    /**
                     * @brief Callback function that is called when the update of the variables into the plant has been (asynchronously) completed successfully.
                     */
                    updatePlantCompleted() {
                        parent.htkDialogs.closeWaitDialog();
                        parent.htkDialogs.showInformationDialog("Plant updated successfully. Do not forget to load.");
                    }

                    /**
                     * @brief Callback function that is called when the update of the variables into the plant has been (asynchronously) completed with an error.
                     */
                    updatePlantError() {
                        parent.htkDialogs.closeWaitDialog();
                        parent.htkDialogs.showErrorDialog("Failed to update plant values. Unknown error, check the server logs.");
                    }

                    /**
                     * @brief Callback function that is called when the commit of the variables into the schedule has been (asynchronously) completed successfully.
                     */
                    commitCompleted() {
                        var mainFrameHtkComponents = parent.htkHelper.getAllMainFrameHtkComponents();
                        var keys = Object.keys(mainFrameHtkComponents);
                        for (var i=0; i<keys.length; i++) {
                            var htkCompArray = mainFrameHtkComponents[keys[i]];
                            for (var j=0; j<htkCompArray.length; j++) {
                                var htkComp = htkCompArray[j];
                                htkComp.setInitialValue(htkComp.getValue());
                            }
                        }
                        parent.htkDialogs.closeWaitDialog();
                    }

                    /**
                     * @brief Callback function that is called when the commit of the variables into the schedule has been (asynchronously) completed with an error.
                     */
                    commitError() {
                        parent.htkDialogs.closeWaitDialog();
                    }

                    /**
                     * @brief Helper function to show/hide the accordion pane.
                     */
                    handleAccordionClick(acc) {
                        if (acc.className.indexOf("w3-show") == -1) {
                            acc.className += " w3-show";
                        } else { 
                            acc.className = acc.className.replace(" w3-show", "");
                        }
                    }

                    /**
                     * @brief Hides the navigation pane.
                     */
                    hideSideBar() {
                        this.sideBar.style.display = "none";
                    }

                    /**
                     * @brief Callback function that is called when all the variables have been loaded.
                     * @details Enables the buttons that allow to interact with the variables.
                     */
                    variablesInfoLoaded() {
                        this.referenceSelectScheduleButton.disabled = false;
                        this.referenceSelectNoneButton.disabled = false;
                        this.referenceSelectPlantButton.disabled = false;
                        this.currentDisplay.innerHTML = PLANT_NAME;
                    }

                    /**
                     * @brief Callback function that is called when a user has been successfully logged in.
                     * @details Starts the HtkStream and allows the user to interact with the system.
                     */
                    loginSuccessful(user) {
                        this.user = user;
                        parent.htkHelper.getUsers(
                            function (allUsers) {
                                this.streamer.start();
                                this.usernameDisplay.innerHTML = this.user.username; 
                                this.usernameDisplay.title = "username: " + this.user.username;
                                this.loginButton.innerHTML = "<i class='fa fa-user-o'> Logout</i>";
                                this.projectSelectButton.disabled = false;
                            }.bind(this),
                            function (response) {
                                console.log(response);
                                alert(response);
                            }
                        );
                    }

                    /**
                     * @brief Informs all registered components that a new schedule has been selected to be displayed.
                     * @param[in] schedule the schedule that was selected.
                     */ 
                    fireScheduleChanged(schedule) {
                        for(var l in this.scheduleChangeListeners) {
                            this.scheduleChangeListeners[l].scheduleChanged(schedule);
                        }
                    }
                  
                    /**
                     * @brief Informs all registered components that a new page has been selected.
                     * @param[in] page the page that was selected.
                     */ 
                    fireProjectChanged(projectName) {
                        this.componentSelectButton.disabled = false;
                        this.switchSelectorButton.disabled =false;               
                        this.selectedproject = projectName;
                        this.commitButton.disabled=false;
                        this.copyAccordionButton.disabled=false;
                        this.loadIntoPlantButton.disabled = false;
                        this.downloadButton.disabled = false;
                        for(var l in this.projectListeners) {
                            this.projectListeners[l].projectChanged(projectName);
                        }
                    }

					saveProject(newProjectName) {
					    parent.htkHelper.copyProject(this.selectedproject, newProjectName); 
					}
			

                    /**
                     * @brief Informs all registered components that a new page has been selected.
                     * @param[in] page the page that was selected.
                     */ 
                    firePageChanged(page) {
                        for(var l in this.pageListeners) {
                            this.pageListeners[l].pageChanged(page);
                        }
                        this.pageChanged(page);
                    }
                    
					fireComponentChanged(component, objectName, componentType, componentName) {
					    for(var l in this.componentListeners) {
                            this.componentListeners[l].componentChanged(component, objectName, componentType, componentName);
                        }
					}

                    /**
                     * @brief Informs all registered components that a user was logged out.
                     */ 
                    fireUserLogout() {
                        for(var l in this.userLogoutListeners) {
                            this.userLogoutListeners[l].userLogout();
                        }
                    }

                    /**
                     * @brief Callback function which is called when an invalid token is received from the server.
                     */
                    invalidTokenReceived() {
                        parent.htkDialogs.closeWaitDialog();
                        parent.htkDialogs.showErrorDialog("You have been logged out from the server. Please login again.");
                        this.fireUserLogout();
                    }

                    /**
                     * @brief Logsout a user from the system and disables the buttons that allow to interact with the system.
                     */
                    userLogout() {
                        parent.htkHelper.logout(
                            function() {
                                localStorage.removeItem("user");
                                localStorage.removeItem("schedule");
                                this.usernameDisplay.innerHTML = "(login first)"
                                this.currentDisplay.innerHTML = NONE_NAME; 
                                this.currentDisplay.style.color = NONE_COLOR; 
                                this.currentReference.innerHTML = NONE_NAME; 
                                this.currentReference.style.color = NONE_COLOR; 
                                this.loginButton.innerHTML = "<i class='fa fa-user-o'> Login</i>";
                                this.projectSelectButton.disabled = true;
                                this.switchSelectorButton.disabled =true;
                                this.componentSelectButton.disabled = true;
                                this.disableAllButPageSelect();
                                if (!this.standalone) {
                                    this.streamer.stop();
                                }
                            }.bind(this),
                            function() {
                            }
                        );
                    }

                    /**
                     * @brief Disables all the buttons, but the one that allows to load a new page.
                     */
                    disableAllButPageSelect() {
                        this.downloadButton.disabled = true;
                        this.loadIntoPlantButton.disabled = true;
                        this.editScheduleButton.disabled = true;
                        this.transformationsButton.disabled = true;
                        this.viewPlantButton.disabled = true;
                        this.viewScheduleButton.disabled = true;
                        this.copyFromReferenceScheduleButton.disabled = true;
                        this.copyFromReferencePlantButton.disabled = true;
                        this.referenceSelectScheduleButton.disabled = true;
                        this.referenceSelectNoneButton.disabled = true;
                        this.referenceSelectPlantButton.disabled = true;
                        this.commitButton.disabled = true;
                        this.undoButton.disabled = true;
                        this.copyAccordionButton.disabled = true;
                    }

                    /**
                     * @brief Gets all the transformations that are available for a given page.
                     */
                    getTransformations() {
                        parent.htkDialogs.showWaitDialog();
                        parent.htkHelper.getTransformations(
                            this.selectedPage.name,
                            function (transformations) {
                                this.transformationsViewer.setTransformations(transformations);
                                this.editScheduleButton.disabled = false;
                                this.loadIntoPlantButton.disabled = false;
                                this.transformationsButton.disabled = false;
                                this.viewScheduleButton.disabled = false;
                                this.viewPlantButton.disabled = false;
                                this.referenceSelectScheduleButton.disabled = false;
                                this.referenceSelectNoneButton.disabled = false;
                                this.referenceSelectPlantButton.disabled = false;
                                parent.htkDialogs.closeWaitDialog();
                            }.bind(this),
                            function (response) {
                                parent.htkDialogs.closeWaitDialog();
                                parent.htkDialogs.showErrorDialog("Failed to getTransformations. Unknown error, check the server logs.");
                            }
                        );
                    }

                    /**
                     * @brief Callback function that is called when a user selects a different page.
                     * @param[in] page the page that was selected by the user.
                     */
                    pageChanged(page) {
                        this.selectedPage = page.name;
                        this.componentSelectButton.disabled = false;
                        this.switchSelectorButton.disabled =false;
                    }

                    /**
                     * @brief Callback function that is called when a user selects a different component.
                     * @param[in] component the component that was selected by the user.
                     */
                    componentChanged(component, objectName, componentType, componentName) {
                        objectName += ".xml";
                        if(componentType == 0){
                            componentName += "_GAM.xml";
                        	parent.htkHelper.addGam(this.selectedproject, this.user.username, component, objectName, componentName);
                        	this.gamList.push(objectName);
                        	this.gamList.push(componentName);
                        }
                        if(componentType == 1){
                            componentName += "_DataSource.xml";
                        	parent.htkHelper.addDataSource(this.selectedproject, this.user.username, component, objectName, componentName);
                        	this.datasourceList.push(objectName);
                        	this.datasourceList.push(componentName);
                        }
                        if(componentType == 2){
                            componentName += "_Interface.xml";
                        	parent.htkHelper.addInterface(this.selectedproject, this.user.username, component, objectName, componentName);
                        	this.interfaceList.push(objectName);
                        	this.interfaceList.push(componentName);
                        }                        
                    }

					

                    /**
                     * @brief Callback function that is called when a user selects a different schedule to be displayed.
                     * @param[in] schedule the schedule that was selected by the user.
                     */
                    scheduleChanged(schedule) {
                        var currentScheduleText = schedule.name;
                        this.currentDisplay.innerHTML = currentScheduleText;
                        if (schedule.inheritsFromUID !== undefined) {
                            if (schedule.inheritsFromUID.length > 0) {
                                parent.htkHelper.getSchedule(
                                    schedule.inheritsFromUID, 
                                    function (parentSchedule) {
                                        currentScheduleText += " (" + parentSchedule.name + ")";
                                        this.currentDisplay.innerHTML = currentScheduleText;
                                    }.bind(this),
                                    function (response) {
                                    }
                                );
                            }
                        }
                        parent.htkHelper.setCurrentScheduleUID(schedule.uid);
                        parent.htkHelper.resetScheduleValuesToCommit();
                        this.downloadButton.disabled = false;
                    }

                    /**
                     * @brief Callback function that is called when a new reference is selected. Calls setReference.
                     */
                    refererenceScheduleChanged(schedule) {
                        var referenceScheduleText = schedule.name;
                        this.currentReference.innerHTML = referenceScheduleText; 
                        if (schedule.inheritsFromUID !== undefined) {
                            if (schedule.inheritsFromUID.length > 0) {
                                parent.htkHelper.getSchedule(
                                    schedule.inheritsFromUID, 
                                    function (parentSchedule) {
                                        referenceScheduleText += " (" + parentSchedule.name + ")";
                                        this.currentReference.innerHTML = referenceScheduleText;
                                    }.bind(this),
                                    function (response) {
                                    }
                                );
                            }
                        }

                        this.setReference(schedule.uid);
                    }

                    /**
                     * @brief Callback function that is called when the user requests to update the variables values with values from a given schedule. Calls copyFromSchedule.
                     */
                    copyFromScheduleChanged(schedule) {
                        this.copyFromSchedule(schedule.uid, false, true, false, function (){});
                    }

                    /**
                     * @brief Callback function that is called when the user requests to edit a given schedule. Updates the current variables values by calling copyFromSchedule.
                     */
                    editScheduleChanged(schedule) {
                        this.copyFromSchedule(schedule.uid, true, false, false, function() {
                            this.copyFromReferenceScheduleButton.disabled = false;
                            this.copyFromReferencePlantButton.disabled = false;
                            this.commitButton.disabled = false;
                            this.copyAccordionButton.disabled = false;
                            this.undoButton.disabled = false;
                            this.fireScheduleChanged(schedule);
                        }.bind(this));
                    }

                    /**
                     * @brief Callback function that is called when the user requests to view a given schedule. Updates the current variables values by calling copyFromSchedule.
                     */
                    viewScheduleChanged(schedule) {
                        this.copyFromSchedule(schedule.uid, true, false, true, function() {
                            this.copyFromReferenceScheduleButton.disabled = true;
                            this.copyFromReferencePlantButton.disabled = true;
                            this.commitButton.disabled = true;
                            this.copyAccordionButton.disabled = true;
                            this.undoButton.disabled = true;
                            this.fireScheduleChanged(schedule);
                        }.bind(this));
                    }
              
                    /**
                     * @brief Registers a component that wants to be informed about schedule changes.
                     * @param[in] listener the component to register.
                     */
                    addScheduleChangedListener(listener) {
                        this.scheduleChangeListeners.push(listener);
                    }

                    /**
                     * @brief Registers a component that wants to be informed about page changes.
                     * @param[in] listener the component to register.
                     */
                    addProjectListener(listener) {
                        this.projectListeners.push(listener);
                    }
 
                    /**
                     * @brief Registers a component that wants to be informed about page changes.
                     * @param[in] listener the component to register.
                     */
                    addPageListener(listener) {
                        this.pageListeners.push(listener);
                    }
        
                    addComponentListener(listener) {
                        this.componentListeners.push(listener);
                    }
        
                    /**
                     * @brief Registers a component that wants to be informed when the user logsout from the system.
                     * @param[in] listener the component to register.
                     */
                    addUserLogoutListener(listener) {
                        this.userLogoutListeners.push(listener);
                    }

                    /**
                     * @brief Updates the reference on all the hieratika components.
                     * @param[in] currentReference the reference to set as one of:
                     *  - NONE_NAME (resets the reference to NONE)
                     *  - PLANT_NAME (sets the reference as the plant)
                     *  - currentReference a reference with the name currentReference
                     */
                    setReference(currentReference) {
                        parent.htkDialogs.showWaitDialog();
                        var mainFrameHtkComponents = parent.htkHelper.getAllMainFrameHtkComponents();
                        var keys = Object.keys(mainFrameHtkComponents);
                        var htkComp;
                        if (currentReference === NONE_NAME) {
                            //Reset all the values to N/A
                            for (var i=0; i<keys.length; i++) {
                                var htkCompArray = mainFrameHtkComponents[keys[i]];
                                for (var j=0; j<htkCompArray.length; j++) {
                                    var htkComp = htkCompArray[j];
                                    htkComp.setReferenceValue("N/A");
                                    htkComp.setReference(currentReference);
                                }
                            }
                            parent.htkDialogs.closeWaitDialog();
                        }
                        else if (currentReference === PLANT_NAME) {
                            for (var i=0; i<keys.length; i++) {
                                var htkCompArray = mainFrameHtkComponents[keys[i]];
                                for (var j=0; j<htkCompArray.length; j++) {
                                    var htkComp = htkCompArray[j];
                                    htkComp.setReferenceValue(htkComp.getPlantValue());
                                    htkComp.setReference(currentReference);
                                }
                            }
                            parent.htkDialogs.closeWaitDialog();
                        }
                        else {
                            parent.htkHelper.getScheduleVariablesValues(
                                currentReference,
                                function(variables) {
                                    var keys = Object.keys(variables);
                                    for (var i in keys) { 
                                        var variableName = keys[i];
                                        var variableValue = variables[keys[i]];
                                        var htkCompArray = mainFrameHtkComponents[variableName];
                                        if (htkCompArray !== undefined) {
                                            for (var j=0; j<htkCompArray.length; j++) {
                                                var htkComp = htkCompArray[j];
                                                htkComp.setReferenceValue(variableValue);
                                                htkComp.setReference(currentReference);
                                            }
                                        }
                                    }
                                    parent.htkDialogs.closeWaitDialog();
                                },
                                function () {
                                    parent.htkDialogs.closeWaitDialog();
                                    parent.htkDialogs.showErrorDialog("Failed to update plant values. Unknown error, check the server logs.");
                                }
                            );
                        }
                    }
                    
                    /**
                     * @brief Copies the values from a given schedule into all the components.
                     * @param[in] schUID the schedule identifier (i.e. the schedule name).
                     * @param[in] resetValue if true, for all the components, the initial value will be set against the retrieved schedule value.
                     * @param[in] updateRemote if true, for all the components, the update will be propagated to the server (see HtkComponent.setValue).
                     * @param[in] setNotEditable if true, for all the components, the component will be set as read-only.
                     * @param[in] successFun the function to be called when all the variables have been copied.
                     */
                    copyFromSchedule(schUID, resetValue, updateRemote, setNotEditable, successFun) {
                        parent.htkDialogs.showWaitDialog();
                        parent.htkHelper.getScheduleVariablesValues(
                            schUID, 
                            function (variables) {
                                var keys = Object.keys(variables);
                                var mainFrameHtkComponents = parent.htkHelper.getAllMainFrameHtkComponents();
                                for (var i in keys) { 
                                    var variableName = keys[i];
                                    var variableValue = variables[keys[i]];
                                    var targetElements = mainFrameHtkComponents[variableName];
                                    if (targetElements != null) {
                                        for (var j=0; j<targetElements.length; j++) {
                                            var targetElement = targetElements[j];
                                            //resetValue = true => change of schedule
                                            var update = resetValue;
                                            if (!update) {
                                                //Do not overwrite locked components!
                                                update = !targetElement.isReadOnly();
                                            }
                                            if (update) {
                                                if (resetValue) {
                                                    targetElement.setInitialValue(variableValue);
                                                }
                                                targetElement.setValue(variableValue, updateRemote);
                                            }
                                            targetElement.setEditable(!setNotEditable);
                                        }
                                    }
                                }
                                successFun();
                                parent.htkDialogs.closeWaitDialog();
                            },
                            function () {
                                parent.htkDialogs.closeWaitDialog();
                                parent.htkDialogs.showErrorDialog("Failed to copy from the schedule. Unknown error, check the server logs.");
                            }
                        );
                    }

                    /**
                     * @brief Undos all the changes that were made to a given schedule.
                     */
                    undoAllChangesToSchedule() {
                        var mainFrameHtkComponents = parent.htkHelper.getAllMainFrameHtkComponents();
                        var keys = Object.keys(mainFrameHtkComponents);
                        for (var i=0; i<keys.length; i++) {
                            var htkCompArray = mainFrameHtkComponents[keys[i]];
                            for (var j=0; j<htkCompArray.length; j++) {
                                var htkComp = htkCompArray[j];
                                htkComp.setValue(htkComp.getInitialValue());
                            }
                        }
                    }
                }

                /**
                 * @brief Registers the element.
                 */ 
                document.registerElement("htk-nav", {
                    prototype: HtkNav.prototype,
                });
            }());
        </script>
    </body>
</html>
